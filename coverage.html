
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">inforce/inforce.go (8.3%)</option>
				
				<option value="file1">inforce/model.go (83.3%)</option>
				
				<option value="file2">inforce/modelCompany.go (67.7%)</option>
				
				<option value="file3">inforce/modelDept.go (91.7%)</option>
				
				<option value="file4">inforce/modelGroup.go (65.0%)</option>
				
				<option value="file5">inforce/modelUserInfo.go (33.3%)</option>
				
				<option value="file6">inforce/server.go (72.7%)</option>
				
				<option value="file7">inforce/serviceCompany.go (0.0%)</option>
				
				<option value="file8">inforce/serviceDepartment.go (0.0%)</option>
				
				<option value="file9">inforce/serviceUser.go (0.0%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">no coverage</span>
				<span class="cov1">low coverage</span>
				<span class="cov2">*</span>
				<span class="cov3">*</span>
				<span class="cov4">*</span>
				<span class="cov5">*</span>
				<span class="cov6">*</span>
				<span class="cov7">*</span>
				<span class="cov8">*</span>
				<span class="cov9">*</span>
				<span class="cov10">high coverage</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" >package inforce

import (
        "bytes"
        "encoding/json"
        "errors"
        "fmt"
        "html/template"
        "net/http"
        "time"

        "appengine"
        "appengine/datastore"
        "appengine/memcache"
        "github.com/gorilla/mux"
        "github.com/gorilla/schema"
        "github.com/gorilla/sessions"
)

var templates *template.Template
var store = sessions.NewCookieStore([]byte("something-very-secret"))

func init() <span class="cov8" title="1">{
        templates = template.Must(template.
                ParseFiles(
                "views/_layout.tmpl",
                "views/home/index.tmpl",
                "views/home/_companies.tmpl",
                "views/home/_company.tmpl"))

        r := mux.NewRouter()

        r.HandleFunc("/", errorHandler(rootHandler)).Methods("GET")
        r.HandleFunc("/addCompany", errorHandler(addCompanyHandler)).Methods("POST")
        r.HandleFunc("/addDepartment", errorHandler(addDepartmentHandler)).Methods("POST")
        r.HandleFunc("/getCompanies", errorHandler(getCompaniesHandler))
        r.HandleFunc("/getCompany", errorHandler(getCompanyHandler))
        r.HandleFunc("/getCompany/{id:[0-9]+}", errorHandler(getCompanyByIdHandler))
        r.HandleFunc("/sendCompanyMsg", errorHandler(sendCompanyMsgHandler))
        r.HandleFunc("/sendDeptMsg", errorHandler(sendDeptMsgHandler))
        r.HandleFunc("/sendGroupMsg", errorHandler(sendGroupMsgHandler))
        r.HandleFunc("/sendP2pMsg", errorHandler(sendP2pMsgHandler))
        r.HandleFunc("/addCompUser", errorHandler(addCompUserHandler))
        r.HandleFunc("/setUser", errorHandler(setUserHandler))

        http.Handle("/", r)
        registerServices()

        //endpoints.HandleHTTP()
}</span>

// Root handler
func rootHandler(w http.ResponseWriter, r *http.Request) error <span class="cov0" title="0">{
        c := appengine.NewContext(r)
        t := time.Now()
        const layout = "Jan 2, 2006 at 3:04pm (MST)"
        companies, err := GetAllCompanies(c)

        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">m := &amp;IndexVm{Title: "Test", Header: "PaX Test",
                CurrentDate: t.Format(layout), Companies: &amp;companies,
                HasCompanies: (len(companies) &gt; 0), NumCompanies: (len(companies))}
        return renderIndexTmpl(w, m)</span>
}

func addCompanyHandler(w http.ResponseWriter, r *http.Request) error <span class="cov0" title="0">{
        c := appengine.NewContext(r)
        compName := r.FormValue("companyName")

        if len(compName) &lt; 1 </span><span class="cov0" title="0">{
                w.WriteHeader(200)
                return nil
        }</span>

        <span class="cov0" title="0">company := &amp;Company{
                Name: compName,
        }

        if _, err := AddCompany(c, company); nil != err </span><span class="cov0" title="0">{
                c.Infof("Error: error adding company: %v", err)
                return err
        }</span>

        <span class="cov0" title="0">memcache.Delete(c, "cList")
        w.WriteHeader(200)
        return nil</span>
}

func setUserHandler(w http.ResponseWriter, r *http.Request) error <span class="cov0" title="0">{
        c := appengine.NewContext(r)
        username := r.FormValue("username")

        user, err := GetUser(c, username)
        if nil != err </span><span class="cov0" title="0">{
                c.Infof("No user found:" + err.Error())
                err = errors.New("No user found: " + err.Error())
                return err
        }</span>

        <span class="cov0" title="0">session, _ := store.Get(r, "default")
        session.Values["username"] = user.Username
        session.Values["firstname"] = user.Firstname
        session.Values["lastname"] = user.Lastname

        session.Save(r, w)
        w.WriteHeader(200)
        return nil</span>
}

func addCompUserHandler(w http.ResponseWriter, r *http.Request) error <span class="cov0" title="0">{
        c := appengine.NewContext(r)
        err := r.ParseForm()

        if nil != err </span><span class="cov0" title="0">{
                http.Error(w, err.Error(), http.StatusInternalServerError)
        }</span>

        <span class="cov0" title="0">d := schema.NewDecoder()

        acuvm := new(AddCompUserVm)
        if err := d.Decode(acuvm, r.PostForm); nil != err </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">if len(acuvm.CompanyName) &lt; 1 || len(acuvm.NewUsername) &lt; 1 ||
                len(acuvm.NewUserFname) &lt; 1 || len(acuvm.NewUserLname) &lt; 1 </span><span class="cov0" title="0">{
                w.WriteHeader(200)
                return nil
        }</span>
        <span class="cov0" title="0">company, err := GetCompany(c, acuvm.CompanyName)
        if nil != err </span><span class="cov0" title="0">{
                c.Infof("Error: company not found: %v", err)
                return err
        }</span>

        <span class="cov0" title="0">user, err := GetUser(c, acuvm.NewUsername)
        if nil != err </span><span class="cov0" title="0">{
                user = &amp;UserInfo{
                        Username:  acuvm.NewUsername,
                        Firstname: acuvm.NewUserFname,
                        Lastname:  acuvm.NewUserLname,
                }
        }</span>

        <span class="cov0" title="0">_, err = company.AddUser(c, user)

        if nil != err </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">w.WriteHeader(200)
        return nil</span>
}

func sendCompanyMsgHandler(w http.ResponseWriter, r *http.Request) error <span class="cov0" title="0">{
        c := appengine.NewContext(r)
        compName := r.FormValue("company")
        msgToAdd := r.FormValue("companyMessage")
        username := r.FormValue("username")

        if len(compName) &lt; 1 || len(msgToAdd) &lt; 1 </span><span class="cov0" title="0">{
                w.WriteHeader(200)
                return nil
        }</span>

        <span class="cov0" title="0">user, err := GetUser(c, username)
        if nil != err </span><span class="cov0" title="0">{
                c.Infof("Error getting user: %v", err)
                return err
        }</span>

        <span class="cov0" title="0">m := &amp;Message{
                FromUser: *user,
                Text:     msgToAdd,
        }

        company, err := GetCompany(c, compName)
        if nil != err </span><span class="cov0" title="0">{
                c.Infof("Error getting user: %v", err)
                return err
        }</span>

        <span class="cov0" title="0">_, err = company.AddMessage(c, m)
        if nil != err </span><span class="cov0" title="0">{
                c.Infof("Error adding message: %v", err)
                return err
        }</span>

        <span class="cov0" title="0">if _, err = AddCompany(c, company); nil != err </span><span class="cov0" title="0">{
                c.Infof("Couldn't update company with user: %v", err)
                return err
        }</span>

        <span class="cov0" title="0">return nil</span>
}

func sendDeptMsgHandler(w http.ResponseWriter, r *http.Request) error <span class="cov0" title="0">{
        //c := appengine.NewContext(r)
        return nil
}</span>

func sendGroupMsgHandler(w http.ResponseWriter, r *http.Request) error <span class="cov0" title="0">{
        //c := appengine.NewContext(r)
        return nil
}</span>

func sendP2pMsgHandler(w http.ResponseWriter, r *http.Request) error <span class="cov0" title="0">{
        //c := appengine.NewContext(r)
        return nil
}</span>

func addDepartmentHandler(w http.ResponseWriter, r *http.Request) error <span class="cov0" title="0">{
        c := appengine.NewContext(r)
        err := r.ParseForm()

        if nil != err </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">d := schema.NewDecoder()
        advm := new(AddDeptVm)
        if err := d.Decode(advm, r.PostForm); nil != err </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">company, err := GetCompany(c, advm.CompanyName)

        dept := &amp;Dept{
                Name:       advm.NewDeptName,
                CompanyKey: company.Key(c),
        }
        if _, err = company.AddDept(c, dept); nil != err </span><span class="cov0" title="0">{
                c.Infof("Error: error adding department: %v", err)
                return err
        }</span>
        <span class="cov0" title="0">return nil</span>
}

func getCompaniesHandler(w http.ResponseWriter, r *http.Request) error <span class="cov0" title="0">{
        c := appengine.NewContext(r)

        outputType := r.FormValue("type")

        if companies, err := GetAllCompanies(c); err != nil </span><span class="cov0" title="0">{
                c.Infof("Error - could not get companies: %v", err)
                return err
        }</span><span class="cov0" title="0"> else {
                if "json" == outputType || "" == outputType </span><span class="cov0" title="0">{

                        b, err := json.Marshal(companies)
                        if nil != err </span><span class="cov0" title="0">{
                                return err
                        }</span>
                        <span class="cov0" title="0">w.Header().Set("Content-Type", "application/json")
                        fmt.Fprint(w, string(b))</span>
                }<span class="cov0" title="0"> else if "html" == outputType </span><span class="cov0" title="0">{
                        hasCs := (len(companies) &gt; 0)
                        cvm := &amp;CompaniesVm{
                                Companies:       &amp;companies,
                                SelectedCompany: "Sagicor",
                                HasCompanies:    hasCs,
                                NumCompanies:    len(companies),
                        }
                        rendLstCompsPartTmpl(w, cvm)
                }</span>
                <span class="cov0" title="0">if nil != err </span><span class="cov0" title="0">{
                        c.Infof("Error - could not convert to JSON: %v", err)
                        return err
                }</span>
        }
        <span class="cov0" title="0">return nil</span>
}

func getCompanyHandler(w http.ResponseWriter, r *http.Request) error <span class="cov0" title="0">{
        c := appengine.NewContext(r)
        err := r.ParseForm()

        if nil != err </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">d := schema.NewDecoder()
        cvm := new(CompaniesVm)
        if err := d.Decode(cvm, r.PostForm); nil != err </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">company, err := GetCompany(c, cvm.SelectedCompany)
        if nil != err </span><span class="cov0" title="0">{
                c.Infof("No company found: %v", cvm.SelectedCompany)
                return err
        }</span>
        <span class="cov0" title="0">departments, err := company.GetDepts(c)
        if nil != err </span><span class="cov0" title="0">{
                return err
        }</span>
        <span class="cov0" title="0">groups, err := company.GetGroups(c)
        if nil != err </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">session, _ := store.Get(r, "default")
        su := ""
        if len(company.Users) &gt; 0 &amp;&amp; nil != session.Values["username"] </span><span class="cov0" title="0">{
                su = session.Values["username"].(string)
        }</span>

        <span class="cov0" title="0">isUserSessionSet := false
        if _, ok := session.Values["username"]; ok </span><span class="cov0" title="0">{
                isUserSessionSet = true
        }</span>

        <span class="cov0" title="0">messages, err := company.GetMessagesByCount(c, 10)
        if nil != err </span><span class="cov0" title="0">{
                return err
        }</span>
        //hasMsg := len(messages) &gt; 0

        <span class="cov0" title="0">companyUsers, err := GetUsers(c, company.Users)
        if nil != err </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">m := &amp;CompanyVm{
                Name:             company.Name,
                Departments:      &amp;departments,
                Groups:           &amp;groups,
                NumDepartments:   len(departments),
                NumGroups:        len(groups),
                IsNoError:        true,
                CompanyUsers:     companyUsers,
                IsUserSessionSet: isUserSessionSet,
                SessionUser:      su,
                CompanyMessages:  messages,
                HasMessages:      len(messages) &gt; 0,
                MessageCount:     len(messages),
        }

        //c.Infof("model: %v", m)

        return renderCompPartialTmpl(w, m)</span>
}

func getCompanyByIdHandler(w http.ResponseWriter, r *http.Request) error <span class="cov0" title="0">{
        c := appengine.NewContext(r)
        vars := mux.Vars(r)
        companyName := vars["id"]

        company, err := GetCompany(c, companyName)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">w.Header().Set("Content-Type", "application/json")
        return json.NewEncoder(w).Encode(company)</span>
}

func renderIndexTmpl(w http.ResponseWriter, m *IndexVm) error <span class="cov0" title="0">{
        return templates.ExecuteTemplate(w, "main", m)
}</span>

func rendLstCompsPartTmpl(w http.ResponseWriter, m *CompaniesVm) string <span class="cov0" title="0">{
        var doc bytes.Buffer
        err := templates.ExecuteTemplate(&amp;doc, "selectcompanies", m)
        if nil != err </span><span class="cov0" title="0">{
                http.Error(w, err.Error(), http.StatusInternalServerError)
                return ""
        }</span>
        <span class="cov0" title="0">fmt.Fprint(w, doc.String())
        return doc.String()</span>
}

func renderCompPartialTmpl(w http.ResponseWriter, m *CompanyVm) error <span class="cov0" title="0">{
        return templates.ExecuteTemplate(w, "showcompany", m)
}</span>

func getDeptGroups(c appengine.Context, cName string,
        dName string) ([]Group, error) <span class="cov0" title="0">{

        company := &amp;Company{Name: cName}
        ck := company.Key(c)
        dept := &amp;Dept{Name: dName, CompanyKey: ck}
        var groups []Group
        c.Infof("Department Key: %v", dept.Key(c))

        q := datastore.
                NewQuery("Group").Ancestor(dept.Key(c)).
                Order("Name")
        _, err := q.GetAll(c, &amp;groups)

        return groups, err
}</span>

func getMessageKey(c appengine.Context) *datastore.Key <span class="cov0" title="0">{
        return datastore.NewKey(c, "Message", "default_message", 0, nil)
}</span>
</pre>
		
		<pre class="file" id="file1" style="display: none">package inforce

import (
        "appengine"
        "appengine/datastore"
)

type Counter struct {
        Count int64
}

// Gets a key for a specified counter by name
func counterKey(c appengine.Context, counterName string) *datastore.Key <span class="cov10" title="139">{
        return datastore.NewKey(c, "Counter", counterName, 0, nil)
}</span>

// Gets the number of entities
func NumberOf(c appengine.Context, counterName string) (int64, error) <span class="cov2" title="2">{
        k := counterKey(c, counterName)
        var counter Counter
        if err := datastore.Get(c, k, &amp;counter); err != nil </span><span class="cov0" title="0">{
                return 0, err
        }</span>
        <span class="cov2" title="2">return counter.Count, nil</span>
}

func updateCounter(c appengine.Context, counterName string) error <span class="cov9" title="137">{
        key := counterKey(c, counterName)
        count := new(Counter)
        err := datastore.RunInTransaction(c, func(c appengine.Context) error </span><span class="cov9" title="137">{
                err := datastore.Get(c, key, count)
                if err != nil &amp;&amp; err != datastore.ErrNoSuchEntity </span><span class="cov0" title="0">{
                        return err
                }</span>
                <span class="cov9" title="137">count.Count++
                _, err = datastore.Put(c, key, count)
                return err</span>
        }, nil)

        <span class="cov9" title="137">if err != nil </span><span class="cov0" title="0">{
                c.Errorf("Transaction failed: %v", err)
        }</span>
        <span class="cov9" title="137">return err</span>
}
</pre>
		
		<pre class="file" id="file2" style="display: none">package inforce

import (
        "encoding/json"
        "errors"
        "time"

        "appengine"
        "appengine/datastore"
        "appengine/memcache"
)

type Company struct {
        Name  string `json:"Name"`
        Users []*datastore.Key
}

// Gets a company key
func (comp *Company) Key(c appengine.Context) *datastore.Key <span class="cov9" title="236">{
        return datastore.NewKey(c, "Company", comp.Name, 0, companyKey(c))
}</span>

// Gets a key that represents the ancestor for all companies
func companyKey(c appengine.Context) *datastore.Key <span class="cov10" title="240">{
        return datastore.NewKey(c, "Company", "root", 0, nil)
}</span>

// Adds a company
func AddCompany(c appengine.Context, comp *Company) (*datastore.Key, error) <span class="cov8" title="127">{
        key, err := datastore.Put(c, comp.Key(c), comp)
        if nil != err </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="127">return key, updateCounter(c, "Company")</span>
}

func GetCompany(c appengine.Context, compName string) (*Company, error) <span class="cov2" title="2">{
        comp := &amp;Company{Name: compName}
        var company Company
        if err := datastore.Get(c, comp.Key(c), &amp;company); err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov2" title="2">return &amp;company, nil</span>
}

func GetCompanies(c appengine.Context, companyKeys []*datastore.Key) ([]Company, error) <span class="cov0" title="0">{
        companies := make([]Company, len(companyKeys))
        if err := datastore.GetMulti(c, companyKeys, companies); nil != err </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov0" title="0">return companies, nil</span>
}

func (comp *Company) AddDept(c appengine.Context, dept *Dept) (*datastore.Key, error) <span class="cov4" title="9">{
        key, err := datastore.Put(c, dept.Key(c), dept)
        if nil != err </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov4" title="9">return key, updateCounter(c, "DeptsFor_"+comp.Name)</span>
}

func (comp *Company) AddUser(c appengine.Context, user *UserInfo) (*datastore.Key, error) <span class="cov1" title="1">{
        user.TimeAdded = time.Now()
        comp.Users = append(comp.Users, user.Key(c))
        var key *datastore.Key

        txOpts := &amp;datastore.TransactionOptions{XG: true}

        err := datastore.RunInTransaction(c, func(c appengine.Context) error </span><span class="cov1" title="1">{
                // Associate user with company
                key, err1 := datastore.Put(c, comp.Key(c), comp)
                if nil != err1 </span><span class="cov0" title="0">{
                        return err1
                }</span>

                // Associate company with user
                <span class="cov1" title="1">user.Companies = append(user.Companies, key)
                _, err1 = datastore.Put(c, user.Key(c), user)
                if nil != err1 </span><span class="cov0" title="0">{
                        c.Infof("Error associating company with user %v", err1)
                        return err1
                }</span>
                <span class="cov1" title="1">return nil</span>
        }, txOpts)
        <span class="cov1" title="1">if nil != err </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov1" title="1">return key, updateCounter(c, "UsersFor_"+comp.Name)</span>
}

func (comp *Company) AddGroup(c appengine.Context, group *Group) (*datastore.Key, error) <span class="cov2" title="2">{
        return datastore.Put(c, group.Key(c), group)
}</span>

func (comp *Company) AddMessage(c appengine.Context, m *Message) (*datastore.Key, error) <span class="cov8" title="100">{
        m.Timestamp = time.Now()
        mk := datastore.NewIncompleteKey(c, "Message", comp.Key(c))
        return datastore.Put(c, mk, m)
}</span>

// Get all the departments within
func (comp *Company) GetDepts(c appengine.Context) ([]Dept, error) <span class="cov1" title="1">{
        var depts []Dept

        q := datastore.
                NewQuery("Dept").Ancestor(comp.Key(c)).
                Order("Name")

        _, err := q.GetAll(c, &amp;depts)

        return depts, err
}</span>

func (comp *Company) GetDept(c appengine.Context, dname string) (Dept, error) <span class="cov1" title="1">{
        d := &amp;Dept{Name: dname, CompanyKey: comp.Key(c)}
        var dept Dept
        err := datastore.Get(c, d.Key(c), &amp;dept)

        return dept, err
}</span>

func (comp *Company) GetUsers(c appengine.Context) ([]UserInfo, error) <span class="cov1" title="1">{
        users := make([]UserInfo, len(comp.Users))

        if err := datastore.GetMulti(c, comp.Users, users); nil != err </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov1" title="1">return users, nil</span>
}

func (comp *Company) GetMessagesByCount(c appengine.Context, lastN int) ([]Message, error) <span class="cov0" title="0">{
        var msgs []Message

        q := datastore.
                NewQuery("Message").Ancestor(comp.Key(c)).
                Order("-Timestamp").
                Limit(lastN)

        _, err := q.GetAll(c, &amp;msgs)
        return msgs, err
}</span>

func (comp *Company) GetMessages(c appengine.Context, sTime time.Time, eTime time.Time) ([]Message, error) <span class="cov1" title="1">{
        var msgs []Message

        if sTime.After(eTime) </span><span class="cov0" title="0">{
                return nil, errors.New("Start time &gt; end time")
        }</span>

        <span class="cov1" title="1">q := datastore.
                NewQuery("Message").Ancestor(comp.Key(c)).
                Filter("Timestamp &gt;=", sTime).
                Filter("Timestamp &lt;=", eTime).
                Order("Timestamp")

        _, err := q.GetAll(c, &amp;msgs)
        return msgs, err</span>
}

func (comp *Company) GetGroup(c appengine.Context,
        gName string) (*Group, error) <span class="cov1" title="1">{

        if len(gName) == 0 </span><span class="cov0" title="0">{
                err := errors.New("No group specified")
                return nil, err
        }</span>
        <span class="cov1" title="1">refGroup := &amp;Group{Name: gName, CompanyKey: comp.Key(c)}
        var group Group
        if err := datastore.Get(c, refGroup.Key(c), &amp;group); nil != err </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov1" title="1">return &amp;group, nil</span>
}

func (comp *Company) GetGroups(c appengine.Context) ([]Group, error) <span class="cov0" title="0">{
        var groups []Group
        q := datastore.
                NewQuery("Group").Ancestor(comp.Key(c)).
                Order("Name")
        _, err := q.GetAll(c, &amp;groups)

        return groups, err
}</span>

func GetAllCompanies(c appengine.Context) (companies []Company, err error) <span class="cov3" title="4">{
        if cOutStr, err := memcache.Get(c, "cList"); err == memcache.ErrCacheMiss </span><span class="cov3" title="4">{
                q := datastore.
                        NewQuery("Company").Ancestor(companyKey(c)).
                        Order("Name")

                var companies []Company
                keys, err := q.GetAll(c, &amp;companies)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, err
                }</span>

                <span class="cov3" title="4">if len(keys) &lt; 1 </span><span class="cov0" title="0">{
                        return nil, nil
                }</span>

                <span class="cov3" title="4">b, err := json.Marshal(companies)
                if nil != err </span><span class="cov0" title="0">{
                        c.Infof("Error - could not marshal companies to JSON: %v", err)
                        return nil, err
                }</span>

                <span class="cov3" title="4">donech := make(chan bool, 1)
                defer close(donech)
                go func() </span><span class="cov3" title="4">{
                        memcache.Set(c, &amp;memcache.Item{
                                Key:   "cList",
                                Value: []byte(b),
                        })
                        donech &lt;- true
                }</span>()
                <span class="cov3" title="4">select </span>{
                <span class="cov3" title="4">case &lt;-donech:
                        return companies, nil</span>
                }
        }<span class="cov0" title="0"> else {
                var companies []Company
                json.Unmarshal(cOutStr.Value, &amp;companies)
                return companies, nil
        }</span>
}
</pre>
		
		<pre class="file" id="file3" style="display: none">package inforce

import (
        "errors"
        "time"

        "appengine"
        "appengine/datastore"
)

type Dept struct {
        Name       string
        CompanyKey *datastore.Key `datastore:"-"`
}

// Gets a department key
func (d *Dept) Key(c appengine.Context) *datastore.Key <span class="cov10" title="214">{
        return datastore.NewKey(c, "Dept", d.Name, 0, d.CompanyKey)
}</span>

func (dept *Dept) AddGroup(c appengine.Context, group *Group) (*datastore.Key, error) <span class="cov2" title="3">{
        return datastore.Put(c, group.Key(c), group)
}</span>

func (dept *Dept) AddMessage(c appengine.Context, m *Message) (*datastore.Key, error) <span class="cov9" title="200">{
        m.Timestamp = time.Now()
        mk := datastore.NewIncompleteKey(c, "Message", dept.Key(c))
        return datastore.Put(c, mk, m)
}</span>

func (dept *Dept) GetGroups(c appengine.Context) ([]Group, error) <span class="cov1" title="1">{
        var grps []Group

        q := datastore.
                NewQuery("Group").Ancestor(dept.Key(c))

        _, err := q.GetAll(c, &amp;grps)
        return grps, err
}</span>

func (dept *Dept) GetGroup(c appengine.Context, gName string) (*Group, error) <span class="cov1" title="1">{
        refGroup := &amp;Group{Name: gName, DeptKey: dept.Key(c)}
        var g Group
        if err := datastore.Get(c, refGroup.Key(c), &amp;g); nil != err </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov1" title="1">return &amp;g, nil</span>
}

func (dept *Dept) GetLastnMessages(c appengine.Context, lastN int) ([]Message, error) <span class="cov1" title="1">{
        var msgs []Message

        q := datastore.
                NewQuery("Message").Ancestor(dept.Key(c)).
                Order("-Timestamp").
                Limit(lastN)

        _, err := q.GetAll(c, &amp;msgs)
        return msgs, err
}</span>

func (dept *Dept) GetMessages(c appengine.Context, sTime time.Time, eTime time.Time) ([]Message, error) <span class="cov1" title="1">{
        if sTime.After(eTime) </span><span class="cov0" title="0">{
                return nil, errors.New("Start time &gt; end time")
        }</span>

        <span class="cov1" title="1">var msgs []Message

        q := datastore.
                NewQuery("Message").Ancestor(dept.Key(c)).
                Filter("Timestamp &gt;=", sTime).
                Filter("Timestamp &lt;=", eTime).
                Order("Timestamp")

        _, err := q.GetAll(c, &amp;msgs)
        return msgs, err</span>
}
</pre>
		
		<pre class="file" id="file4" style="display: none">package inforce

import (
        "errors"
        "time"

        "appengine"
        "appengine/datastore"
)

type Group struct {
        Name       string
        StartDate  time.Time
        CompanyKey *datastore.Key `datastore:"-"`
        DeptKey    *datastore.Key `datastore:"-"`
}

// Gets a group key
func (group *Group) Key(c appengine.Context) *datastore.Key <span class="cov10" title="9">{

        if nil == group.CompanyKey &amp;&amp; nil == group.DeptKey </span><span class="cov0" title="0">{
                return nil
        }</span>

        <span class="cov10" title="9">if nil != group.CompanyKey </span><span class="cov5" title="3">{
                return datastore.NewKey(c, "Group", group.Name, 0, group.CompanyKey)
        }</span>
        <span class="cov8" title="6">if nil != group.DeptKey </span><span class="cov8" title="6">{
                return datastore.NewKey(c, "Group", group.Name, 0, group.DeptKey)
        }</span>
        <span class="cov0" title="0">return nil</span>
}

func (grp *Group) AddMessage(c appengine.Context, m *Message) (*datastore.Key, error) <span class="cov1" title="1">{
        m.Timestamp = time.Now()
        mk := datastore.NewIncompleteKey(c, "Message", grp.Key(c))
        return datastore.Put(c, mk, m)
}</span>

func (grp *Group) GetMessagesByCount(c appengine.Context, lastN int) ([]Message, error) <span class="cov0" title="0">{
        var msgs []Message

        q := datastore.
                NewQuery("Message").Ancestor(grp.Key(c)).
                Order("-Timestamp").
                Limit(lastN)

        _, err := q.GetAll(c, &amp;msgs)
        return msgs, err
}</span>

func (group *Group) GetMessages(c appengine.Context, sTime time.Time, eTime time.Time) ([]Message, error) <span class="cov1" title="1">{
        var msgs []Message

        if sTime.After(eTime) </span><span class="cov0" title="0">{
                return nil, errors.New("Start time &gt; end time")
        }</span>

        <span class="cov1" title="1">q := datastore.
                NewQuery("Message").Ancestor(group.Key(c)).
                Filter("Timestamp &gt;=", sTime).
                Filter("Timestamp &lt;=", eTime).
                Order("Timestamp")

        _, err := q.GetAll(c, &amp;msgs)
        return msgs, err</span>
}
</pre>
		
		<pre class="file" id="file5" style="display: none">package inforce

import (
        "appengine"
        "appengine/datastore"
        "time"
)

type UserInfo struct {
        Username  string
        Firstname string
        Lastname  string
        TimeAdded time.Time
        Companies []*datastore.Key
}

func (u *UserInfo) Key(c appengine.Context) *datastore.Key <span class="cov10" title="3">{
        return datastore.NewKey(c, "UserInfo", u.Username, 0, nil)
}</span>

func AddUser(c appengine.Context, user *UserInfo) (*datastore.Key, error) <span class="cov1" title="1">{
        user.TimeAdded = time.Now()
        return datastore.Put(c, user.Key(c), user)
}</span>

func GetUser(c appengine.Context, username string) (*UserInfo, error) <span class="cov0" title="0">{
        user := &amp;UserInfo{Username: username}
        var u UserInfo
        if err := datastore.Get(c, user.Key(c), &amp;u); nil != err </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov0" title="0">return &amp;u, nil</span>
}

func GetUsers(c appengine.Context, userKeys []*datastore.Key) ([]UserInfo, error) <span class="cov0" title="0">{
        users := make([]UserInfo, len(userKeys))
        if err := datastore.GetMulti(c, userKeys, users); nil != err </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">return users, nil</span>
}

func (u *UserInfo) GetCompanies(c appengine.Context) ([]Company, error) <span class="cov1" title="1">{
        companies := make([]Company, len(u.Companies))

        if err := datastore.GetMulti(c, u.Companies, companies); nil != err </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov1" title="1">return companies, nil</span>
}

func (u *UserInfo) AddCompany(c appengine.Context, company *Company) (*datastore.Key, error) <span class="cov0" title="0">{
        u.Companies = append(u.Companies, company.Key(c))
        return datastore.Put(c, u.Key(c), u)
}</span>
</pre>
		
		<pre class="file" id="file6" style="display: none">package inforce

import (
        "github.com/crhym3/go-endpoints/endpoints"

        "log"
        "net/http"
)

type badRequest struct{ error }
type notFound struct{ error }

func errorHandler(f func(w http.ResponseWriter, r *http.Request) error) http.HandlerFunc <span class="cov10" title="12">{
        return func(w http.ResponseWriter, r *http.Request) </span><span class="cov0" title="0">{
                err := f(w, r)
                if err == nil </span><span class="cov0" title="0">{
                        return
                }</span>
                <span class="cov0" title="0">switch err.(type) </span>{
                <span class="cov0" title="0">case badRequest:
                        http.Error(w, err.Error(), http.StatusBadRequest)</span>
                <span class="cov0" title="0">case notFound:
                        http.Error(w, "task not found", http.StatusNotFound)</span>
                <span class="cov0" title="0">default:
                        log.Println(err)
                        http.Error(w, "oops", http.StatusInternalServerError)</span>
                }
        }

}

func svcErrorHandler(api *endpoints.RPCService, apierr error) *endpoints.RPCService <span class="cov1" title="1">{
        if nil != apierr </span><span class="cov0" title="0">{
                panic(apierr.Error())
        }</span>

        <span class="cov1" title="1">return api</span>
}

func registerServices() <span class="cov1" title="1">{
        svc := &amp;InforceService{}
        api := svcErrorHandler(endpoints.RegisterService(svc,
                "inforce", "v1", "Companies API", true))

        info := api.MethodByName("CompanyList").Info()
        info.Name, info.HTTPMethod, info.Path, info.Desc = "companies.list", "GET",
                "companies", "List all companies."

        gInfo := api.MethodByName("DeptGroups").Info()
        gInfo.Name, gInfo.HTTPMethod, gInfo.Path, gInfo.Desc = "departments.groups",
                "GET", "groups", "List all groups in a specified company's department."

        cInfo := api.MethodByName("AddCompany").Info()
        cInfo.Name, cInfo.HTTPMethod, cInfo.Path, cInfo.Desc = "companies.add", "POST", "addCompanyResult", "Adds a company."

        addDeptInfo := api.MethodByName("AddDept").Info()
        addDeptInfo.Name, addDeptInfo.HTTPMethod, addDeptInfo.Path, addDeptInfo.Desc = "departments.add", "POST", "addDeptResult", "Adds a department."

        valUserInfo := api.MethodByName("ValidateUserGetCompanies").Info()
        valUserInfo.Name, valUserInfo.HTTPMethod, valUserInfo.Path, valUserInfo.Desc = "userInfos.validate", "POST", "valUserInfoResult", "Validates user and returns the companies belonged to."

        addUserToCompInfo := api.MethodByName("AddUserToCompany").Info()
        addUserToCompInfo.Name, addUserToCompInfo.HTTPMethod, addUserToCompInfo.Path, addUserToCompInfo.Desc = "companies.adduser", "POST", "addUserToCompResult", "Adds a user to a company."

        compUsersInfo := api.MethodByName("CompanyUsersList").Info()
        compUsersInfo.Name, compUsersInfo.HTTPMethod, compUsersInfo.Path, compUsersInfo.Desc = "companies.userlist", "GET", "usersResult", "Gets users within a company."

        userCompInfo := api.MethodByName("UserCompanyList").Info()
        userCompInfo.Name, userCompInfo.HTTPMethod, userCompInfo.Path, userCompInfo.Desc = "userInfos.companylist", "GET", "userCompaniesResult", "Get companies that a user is in."

        getUserInfo := api.MethodByName("GetUserInfo").Info()
        getUserInfo.Name, getUserInfo.HTTPMethod, getUserInfo.Path, getUserInfo.Desc = "userInfos.info", "GET", "userResult", "Get user."

        endpoints.HandleHTTP()
}</span>
</pre>
		
		<pre class="file" id="file7" style="display: none">package inforce

import (
        "github.com/crhym3/go-endpoints/endpoints"
        "net/http"
)

type InforceService struct {
}

func (cs *InforceService) CompanyList(r *http.Request, req *CompaniesListReq, resp *CompaniesList) error <span class="cov0" title="0">{
        c := endpoints.NewContext(r)
        companies, err := GetAllCompanies(c)

        if nil != err </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">resp.Companies = companies
        return nil</span>
}

func (cs *InforceService) AddCompany(
        r *http.Request, req *AddCompanyReq, resp *AddResp) error <span class="cov0" title="0">{
        c := endpoints.NewContext(r)

        company := &amp;Company{Name: req.Name}
        _, err := AddCompany(c, company)

        if nil != err </span><span class="cov0" title="0">{
                resp.IsAdded = false
                return err
        }</span>

        <span class="cov0" title="0">resp.IsAdded = true
        return nil</span>
}

func (cs *InforceService) AddDept(
        r *http.Request, req *AddDeptReq, resp *AddResp) error <span class="cov0" title="0">{
        c := endpoints.NewContext(r)

        company := &amp;Company{Name: req.CompanyName}
        dept := &amp;Dept{Name: req.DepartmentName, CompanyKey: company.Key(c)}

        _, err := company.AddDept(c, dept)

        if nil != err </span><span class="cov0" title="0">{
                resp.IsAdded = false
                return err
        }</span>

        <span class="cov0" title="0">resp.IsAdded = true
        return nil</span>
}

func (cs *InforceService) AddUserToCompany(r *http.Request, req *AddUserToCompReq, resp *AddUserToCompResp) error <span class="cov0" title="0">{

        c := endpoints.NewContext(r)
        u, err := GetUser(c, req.Username)
        if nil != err </span><span class="cov0" title="0">{
                resp.ErrorMsg = "No such user"
                return err
        }</span>

        // Get compnay
        <span class="cov0" title="0">comp, err := GetCompany(c, req.SelectedCompany)
        if nil != err </span><span class="cov0" title="0">{
                resp.ErrorMsg = "No such company"
                return err
        }</span>

        <span class="cov0" title="0">userKey := u.Key(c)
        for _, uk := range comp.Users </span><span class="cov0" title="0">{
                if uk == userKey </span><span class="cov0" title="0">{
                        resp.Success = true
                        return nil
                }</span>
        }

        <span class="cov0" title="0">_, err = comp.AddUser(c, u)
        if nil != err </span><span class="cov0" title="0">{
                resp.ErrorMsg = "Error adding user"
                return err
        }</span>

        <span class="cov0" title="0">resp.Success = true
        return nil</span>
}

func (cs *InforceService) CompanyUsersList(r *http.Request, req *CompanyUsersReq, resp *CompanyUsersResp) error <span class="cov0" title="0">{
        c := endpoints.NewContext(r)

        comp, err := GetCompany(c, req.SelectedCompany)
        if nil != err </span><span class="cov0" title="0">{
                resp.ErrorMsg = "Company not found"
                return err
        }</span>

        <span class="cov0" title="0">users, err := GetUsers(c, comp.Users)
        if nil != err </span><span class="cov0" title="0">{
                resp.ErrorMsg = "An error occurred"
                return err
        }</span>

        <span class="cov0" title="0">resp.Users = users
        return nil</span>
}
</pre>
		
		<pre class="file" id="file8" style="display: none">package inforce

import (
        "errors"
        "github.com/crhym3/go-endpoints/endpoints"
        "net/http"
)

func (cs *InforceService) DeptGroups(
        r *http.Request, req *GroupsListReq, resp *GroupsList) error <span class="cov0" title="0">{

        c := endpoints.NewContext(r)

        if "" == req.SelectedCompany </span><span class="cov0" title="0">{
                err := errors.New("No company selected")
                return err
        }</span>

        <span class="cov0" title="0">if "" == req.SelectedDept </span><span class="cov0" title="0">{
                err := errors.New("No department selected")
                return err
        }</span>

        <span class="cov0" title="0">company := &amp;Company{Name: req.SelectedCompany}
        dept := &amp;Dept{Name: req.SelectedDept, CompanyKey: company.Key(c)}
        grps, err := dept.GetGroups(c)

        if nil != err </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">resp.Groups = grps
        return nil</span>
}
</pre>
		
		<pre class="file" id="file9" style="display: none">package inforce

import (
        "github.com/crhym3/go-endpoints/endpoints"
        "net/http"
)

func (cs *InforceService) ValidateUserGetCompanies(r *http.Request, req *LoginReq, resp *LoginResp) error <span class="cov0" title="0">{
        c := endpoints.NewContext(r)

        u, err := GetUser(c, req.Username)
        if nil != err </span><span class="cov0" title="0">{
                resp.ErrorMsg = "No such user"
                return nil
        }</span>

        <span class="cov0" title="0">companies, err := u.GetCompanies(c)

        if nil != err </span><span class="cov0" title="0">{
                resp.ErrorMsg = "Could not get list of companies: " + err.Error()
                return err
        }</span>

        <span class="cov0" title="0">resp.Success = true
        resp.Companies = companies

        return nil</span>
}

func (cs *InforceService) GetUserInfo(r *http.Request, req *GetUserInfoReq, resp *GetUserInfoResp) error <span class="cov0" title="0">{
        c := endpoints.NewContext(r)

        u, err := GetUser(c, req.Username)
        if nil != err </span><span class="cov0" title="0">{
                resp.ErrorMsg = "No such user"
                return err
        }</span>

        <span class="cov0" title="0">resp.Info = u
        return nil</span>
}

func (cs *InforceService) UserCompanyList(r *http.Request, req *UserCompaniesReq, resp *UserCompaniesResp) error <span class="cov0" title="0">{
        c := endpoints.NewContext(r)

        c.Infof("Here")

        u, err := GetUser(c, req.Username)
        if nil != err </span><span class="cov0" title="0">{
                resp.ErrorMsg = "No such user"
                return err
        }</span>

        <span class="cov0" title="0">companies, err := u.GetCompanies(c)
        if nil != err </span><span class="cov0" title="0">{
                resp.ErrorMsg = "An error occurred"
                return err
        }</span>

        <span class="cov0" title="0">resp.Companies = companies
        return nil</span>
}
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible = document.getElementById('file0');
		files.addEventListener('change', onChange, false);
		function onChange() {
			visible.style.display = 'none';
			visible = document.getElementById(files.value);
			visible.style.display = 'block';
			window.scrollTo(0, 0);
		}
	})();
	</script>
</html>
